@startuml HeatingControlLogic
!include theme.puml

title Heating Control Logic - Space Heating with PID\nWeather Compensation and Hysteresis

start

:HeatingControlTask\n(1s interval);

if (Boiler Enabled?) then (no)
  :Clear HEATING_REQUEST_BIT;
  stop
else (yes)
endif

if (Heating Enabled?) then (no)
  :Clear HEATING_REQUEST_BIT;
  stop
else (yes)
endif

:Read Sensor Data\n- Inside temp (ANDRTF3)\n- Outside temp (MB8ART ch3)\n- Boiler temps (MB8ART ch0,1);

:Calculate Boiler Target\nUsing Heating Curve;

note right
  **Heating Curve Formula:**
  dar = outside - inside
  boilerTarget = targetRoomTemp + shift -
    coeff * dar * (1.4347 + 0.021*dar + 248e-6*dar²)

  **Parameters from SystemSettings:**
  - targetRoomTemp (default 20°C)
  - shift (adjustment factor)
  - coeff (compensation coefficient)
end note

if (boilerTarget < Burner Low Limit?) then (yes)
  :Set to 30°C\n(minimum);
elseif (boilerTarget > Heating High Limit?) then (yes)
  :Set to 80°C\n(maximum);
else (in range)
  :Use calculated\nboiler target;
endif

partition "Hysteresis Logic with State Memory" {
  if (Room Temp vs Target?) then (< Target - 2°C\nAND not heating)
    :Start Heating\nwasHeating = true;
    :Set HEATING_REQUEST_BIT\nEncode boiler target\nin bits 16-23;

    note right
      **Request Encoding:**
      Bit 0 = HEATING_REQUEST
      Bits 16-23 = Target temp

      Example: 70°C = 0x00004601
    end note

    :BurnerControlTask\nwill respond;
    stop
  elseif (> Target + 2°C\nAND heating) then (yes)
    :Stop Heating\nwasHeating = false;
    :Clear HEATING_REQUEST_BIT;
    stop
  else (within ±2°C band)
    if (wasHeating?) then (true)
      :Maintain heating\nSet HEATING_REQUEST_BIT;
      stop
    else (false)
      :Stay off\nClear HEATING_REQUEST_BIT;
      stop
    endif
  endif
}

note bottom
  **Hysteresis Benefits:**
  - Prevents rapid cycling
  - ±2°C dead band
  - State memory (wasHeating)
  - Reduces wear on components
  - More efficient operation
end note

@enduml
